## Дипломная работа к профессии Python-разработчик «API Сервис заказа товаров для розничных сетей»
***

### Общее описание

Приложение предназначено для автоматизации закупок через REST API.
__Все взаимодействие с приложением ведется через API запросы.__

Приложение предоставляет информацию о товарах из разных магазинов.

__Клиент (покупатель) может:__

_Без авторизации:_

+ Просматривать каталог товаров из разных магазинов, осуществляя 
поиск/фильтрацию по различным параметрам, доступна детальная информация о
выбранном товаре с рейтингом и отзывами.
+ Регистрироваться в приложении с активацией по email или через "ВКонтакте",
логиниться в системе.

_С авторизацией:_

+ Добавлять товары в корзину, просматривать и редактировать корзину: 
менять количество у заказанного товара или удалять позиции.

__ВАЖНО!__ В корзине могут одновременно находиться товары только из одного
магазина. Чтобы сформировать заказ из другого магазина, необходимо или отправить
текущий заказ, или очистить корзину.
+ Отправлять заказ в магазин на необходимую дату и временной интервал доставки,
просматривать историю своих заказов с возможностью поиска и фильтрации, просматривать
детальную информацию о конкретном заказе.
+ Отправлять оценку и отзыв на приобретенный товар.
+ Просматривать информацию о своем аккаунте, редактировать его данные.
+ Просматривать, добавлять, редактировать, удалять контактные данные, адреса
для доставки.
+ Сбрасывать и устанавливать новый пароль, выходить из системы.
+ Получать на почту письма при размещении заказа и изменениях его статуса с 
подробной информацией о заказе и примечаниями.

__Менеджер магазина может:__
+ Осуществлять все действия доступные пользователя с ролью "покупатель".
+ Просматривать статус приема заказов магазином, включать и выключать его.
+ Получать на почту письма при создании нового интернет-заказа в магазин с
подробной информацией о заказе.
+ Просматривать заказы магазина с возможностью поиска/фильтрации по
различным критериям, изменять статус заказа и при необходимости дату и время
доставки.
+ Работать с остатками магазина: полностью обновлять остатки или принимать 
накладную с новой поставкой/переоценкой/изменениями описания товара, суммирующуюся
с текущими остатками.
___

### Запуск проекта

1. Клонируйте репозиторий ```git clone https://github.com/AlinaProkofeva/graduate_work.git```
2. Скопируйте шаблон файла с переменными окружения ```cp .env.template .env```
3. В ```.env``` укажите свои переменные.
4. Запустите docker-контейнер ```docker-compose up --build```
___

### Тест-драйв проекта

1. Реализована документация __Swagger__ c подробной информацией по каждому
методу, примерами запросов и возможностью отправки запросов со всеми
аргументами и параметрами url.
2. В основной папке проекта находится файл Диплом_Нетология.postman_collection
со всеми url-адресами и примерами запросов для импорта коллекции и дальнейшего 
тестирования в __Postman__.
3. Реализована __админка__ с валидацией форм.

__!__ Для комфортной работы со swagger и админкой в docker-compose настроен nginx
на 80 порту.

__!__ Также при запуске контейнера __автоматически создается суперпользователь__
для удобства тестирования в админке.

    Данные суперпользователя для входа в админку (при желании перенастройте в .env):

    email: admin@m.ru
    password: 1234

___

## Подробное описание функционала
__
### Управление аккаунтом

#### Пользователи - создание, активация, получение прав

Создаем пользователя по апи:

    POST    http://127.0.0.1:8000/user/register/  

Данные для менеджера магазина:

    {
    "first_name": "Имя",
    "last_name": "Фамилия",
    "email": "some_email@mail.ru",
    "password": "test1234567",
    "company": "Связной",
    "position": "ОМ",
    "type": "shop"
    }

Данные для покупателя

    {
    "first_name": "Имя",
    "last_name": "Фамилия",
    "email": "some_email@mail.ru",
    "password": "test1234567"
    }

Пользователь должен появиться в БД, но будет неактивен.
На указанную почту пользователя придет письмо с темой "Токен для 
подтверждения регистрации some_email@mail.ru", в теле письма будет 
активационный токен.

Для активации аккаунта необходимо перейти на url подтверждения почты
и указать почту и токен из письма:

    POST http://127.0.0.1:8000/user/register/confirm/

    {
    "email": "some_email@mail.ru",
    "token": "0d8d5061eebb938887b030cf4"
    }

При успехе пользователь активируется, в response придет подтверждение:

    {'Status': True, 'is_active': True}

__Регистрация через "Вконтакте"__

    POST http://127.0.0.1:8000/user/register_vk/convert-token/
Возвращает ```access_token```, который используется __вместо email__ при прохождении аутентификации пользователя
по пути `````'user/login/'`````.

В data необходимо передать следующие параметры:

    {
    "grant_type": "convert_token",
    "client_id": "Client id нашего application приложения DJANGO OAUTH TOOLKIT",
    "backend": "vk-oauth2",
    "token": "vk1.a.тут токен, выданный vk при авторизации приложения"
    }

Пользователь будет сразу активен, подтверждение почты не требуется.
Рекомендуется после установить корректную почту и пароль через ```'user/details/'```.

__Log in__

Для управления аккаунтом и менеджерских действий необходимо залогиниться:

    POST  http://127.0.0.1:8000/user/login/
    
    {
    "email": "some_email@mail.ru",
    "password": "test1234567"
    }
    
Если все верно указано, в response придет auth-токен.

Если регистрация была __через VK__, и пользователь еще не сменил данные аккаунта, то в ```email``` необходимо передать
```access token``` пользователя, полученный при регистрации.
Поле ```password``` в таком случае не заполняется или может принимать любое значение.

__Log out__

    POST    http://127.0.0.1:8000/user/logout/

Пользователь должен быть авторизован, в теле запроса передавать ничего
не нужно. Auth токен будет удален из БД.

__

__"Забыл пароль", сброс старого пароля и восстановление доступа к аккаунту__

На адрес сброса пароля передаем почту пользователя:

    POST    http://127.0.0.1:8000/user/password_reset/
    
    {
    "email": "some_email@mail.ru"
    }

На почту придет письмо с темой "Токен для сброса пароля пользователя 
<Имя Фамилия>", в теле письма будет токен для сброса.

Чтобы подтвердить сброс старого пароля пользователя и установить новый
на url подтверждения в data необходимо передать полученный на email 
токен на сброс и новый пароль:

    POST    http://127.0.0.1:8000/user/password_reset/confirm/

    {
    "password": "test12345678",
    "token": "4eedaf6429d7d9bcd6140d89c2a306caff3c8476"
    }

Если данные корректные, то пароль успешно заменится.

__

__Просмотр аккаунта__

    GET   http://127.0.0.1:8000/user/details/

Выдаст подробную информацию о пользователе:

    {
        "id": 6,
        "first_name": "Вечная",
        "last_name": "Весна",
        "email": "some_email@mail.ru",
        "company": "Связной",
        "position": "ОМ",
        "type": "shop",
        "contacts": {
            "phone": "9114433111",
            "addresses": [
                {
                    "id": 5,
                    "region": "Москва",
                    "district": "",
                    "settlement": "",
                    "street": "Арбат",
                    "house": "111",
                    "structure": "",
                    "building": "",
                    "apartment": "1"
                },
                {
                    "id": 6,
                    "region": "Магнитогорск",
                    "district": "",
                    "settlement": "",
                    "street": "Металлургов",
                    "house": "34",
                    "structure": "",
                    "building": "",
                    "apartment": "65"
                }
            ]
        }
    }

__Редактирование аккаунта__

    PATCH   http://127.0.0.1:8000/user/details/

В data необходимо передать новые данные (полностью или частично):

    {
    "first_name": "Новое имя",
    "last_name": "Новая фамилия",
    "email": "new_email@mail.ru",
    "password": "new_password",
    "company": "",
    "position": "",
    "type": "shop"
    }

При смене ```email``` необходимо __повторное подтверждение аккаунта__ с новой почты!

__
### Работа с контактами пользователя

__Посмотреть контакт и адреса пользователя__

    GET     http://127.0.0.1:8000/user/contact/

Выдает информацию о контакте со всеми адресами:

    [
    {
        "phone": "9114433111",
        "addresses": [
            {
                "id": 5,
                "region": "Москва",
                "district": "",
                "settlement": "",
                "street": "Арбат",
                "house": "111",
                "structure": "",
                "building": "",
                "apartment": "1"
            },
            {
                "id": 6,
                "region": "Магнитогорск",
                "district": "",
                "settlement": "",
                "street": "Металлургов",
                "house": "34",
                "structure": "",
                "building": "",
                "apartment": "65"
            }
        ]
    }
    ]

__Добавить новый контакт пользователя/новые адреса к существующему контакту__

    POST    http://127.0.0.1:8000/user/contact/

В data необходимо передать следующие данные: 

```phone``` обязателен только при записи первого адреса, при
добавлении последующих адресов не требуется)

    {
    "phone": 8123334444,
    "region": "Архангельская обл.",
    "district": "",
    "settlement": "Архангельск гор.",
    "street": "Ленина ул.",
    "house": "д. 121",
    "structure": "",
    "building": "стр. 1-Н",
    "apartment": "кв. 80"
    }

Обязательными аргументами являются ```region```, ``street``.

``phone`` обязателен только, если у пользователя еще нет контакта и это добавление первого адреса

__Редактировать контакт/адреса пользователя.__

    PATCH   http://127.0.0.1:8000/user/contact/

При редактировании только номера телефона достаточно в data передать аргумент ``phone``.

При редактировании данных адреса необходимо дополнительно передать ``id`` редактируемой записи и новые данные
(полностью или частично):

    {
    "phone": 8123334444,
    "id": 31,
    "region": "Москва",
    "district": "",
    "settlement": "",
    "street": "Ленина",
    "house": "5",
    "structure": "",
    "building": "Н",
    "apartment": "80"
    }

__Удалить контакт полностью или адрес/несколько адресов пользователя__

    DELETE    http://127.0.0.1:8000/user/contact/

Для **полного удаления** контакта в data необходимо передать `delete_contact`

        {
        "delete_contact": "True"
        }

Для **удаления адреса/адресов контакта** в data необходимо передать `id`/перечень `id` удаляемых адресов в `ids`.

В `ids` можно передать число, текст или список.

        {
        "ids": [27, 28]
        }

При возникновении ошибок будет возвращена их детализация:

    {
        "Status": true,
        "Удалено объектов": 1,
        "Не удалось удалить объектов": 2,
        "Error": "Адресов с такими id не существует, адрес не принадлежит контакту пользователя или у пользователя нет контактных данных"
    }
__
### Товары

__Магазины__

Создавать - можно в админке или через yaml-файл с полной загрузкой
остатков магазина.

Просмотреть список названий магазинов, принимающих заказы:

    GET    http://127.0.0.1:8000/shops/

__

__Категории товара__

Просмотреть список категорий товара:

    GET     http://127.0.0.1:8000/categories/

__

__Просмотр товаров на складах + поиск/фильтрация__

Просмотреть ассортимент магазинов + поиск товаров. Не требует 
авторизации

    GET     http://127.0.0.1:8000/products/

Параметры доступной фильтрации и поиска:

    'shop_id' фильтр по id магазина
    'shop_name' фильтр по названию магазину (без учета регистра, по частичному совпадению)
    'price_more' фильтр по цене больше или равно
    'price_less' фильтр по цене меньше или равно
    'category_id' фильтр по id категории продуктов
    'category' фильтр по названию категории продуктов (без учета регистра, по частичному совпадению)
    
    'search' поиск по названию продукта, модели, наименованию параметра (без учета регистра, по частичному совпадению)

Параметры сортировки:

    'ordering' сортировка по цене, названию продуктов

    (price, -price, product, -product)

Возвращает список с основной информацией о товарах:

    [
        {
            "model": "usb-lightning-2023-34",
            "product": {
                "name": "Кабель для iPhone с магнитом",
                "category": "Компьютерная периферия"
            },
            "shop": "Билайн",
            "price": 800,
            "quantity": 77,
            "total_rating": ""
        },
        {
            "model": "usb-lightning-2023-34",
            "product": {
                "name": "Кабель для iPhone с магнитом",
                "category": "Компьютерная периферия"
            },
            "shop": "Связной",
            "price": 800,
            "quantity": 10,
            "total_rating": 4.0
        },
        {
            "model": "apple/iphone/xr",
            "product": {
                "name": "Смартфон Apple iPhone XR 256GB (красный)",
                "category": "Смартфоны"
            },
            "shop": "Связной",
            "price": 68000,
            "quantity": 0,
            "total_rating": ""
        }]

__Детальная информация о товаре__

    GET   http://127.0.0.1:8000/products/<id>/

  Детализация с описанием, характеристиками, расчетом рейтинга и отзывами.

      {
        "id": 40,
        "product": {
            "name": "Смартфон Apple iPhone 5s 16GB (titan grey)",
            "category": "Смартфоны"
        },
        "description": "Смартфон Apple iPhone 5s – это целый набор потрясающих технологий в удивительно тонком и легком металлическом корпусе. Датчик идентификации по отпечатку пальца Touch ID. A7 – первый мобильный процессор с 64-битной архитектурой. Улучшенная, еще более впечатляющая камера iSight. И сверхскоростная беспроводная связь.",
        "product_parameters": [
            {
                "parameter": "Диагональ (дюйм)",
                "value": "4"
            },
            {
                "parameter": "Разрешение (пикс)",
                "value": "1136x640"
            },
            {
                "parameter": "Встроенная память (Гб)",
                "value": "16"
            },
            {
                "parameter": "Цвет",
                "value": "серый titan grey"
            },
            {
                "parameter": "Год выпуска",
                "value": "2013"
            }
        ],
        "price": 21990,
        "external_id": 4200009,
        "shop": "Билайн",
        "quantity": 14,
        "ratings": [
            {
                "buyer": "Покупатель 1",
                "rating": "5",
                "review": "Огонь!!!"
            },
            {
                "buyer": "Покупатель 2",
                "rating": "1",
                "review": "- :  Отвратительно держит зарядку!"
            },
            {
                "buyer": "Покупатель 3",
                "rating": "5",
                "review": "some text"
            }
        ],
        "total_rating": 3.7
    }

__Поставить оценку приобретенному продукту и оставить отзыв__

Доступно только авторизованному пользователю при условии наличия заказа на оцениваемый продукт.
В data необходимо передать:

        {
        "product_id": 40,
        "rating": 4,
        "review": "тут впечатления от пользования"
        }

`product_id`, `rating` являются обязательными аргументами.
`rating` может быть в диапазоне от 1 до 5, где 5 - максимальная оценка

__

### Управление КОРЗИНОЙ

Доступно только авторизованному пользователю.

**Добавить товар в корзину**

    POST    http://127.0.0.1:8000/basket/

    {
        "ordered_items": [
            {
                "product_info": 123,
                "quantity": 2
            },
            {
                "product_info": 122,
                "quantity": 5
            }
        ]
    }

Товары должны быть **из одного магазина**. Невозможно добавить товар в 
корзину, если в ней уже есть товар из другого магазина. 

Невозможно добавить в корзину уже имеющийся там товар, для этого
необходимо изменить количество через редактирование корзины.

При любых ошибках будет приходить детализация:

    {
    "Status": false,
    "Добавлено товаров в корзину": 0,
    "Errors": [
        {
            "product_info": [
                "Недопустимый первичный ключ \"123\" - объект не существует."
            ]
        },
        {
            "product_info": [
                "Недопустимый первичный ключ \"122\" - объект не существует."
            ]
        }
    ],
    "Не удалось добавить товаров в корзину": 2

**Посмотреть товары в корзине**

    GET     http://127.0.0.1:8000/basket/

В ответе придет информация обо всех товарах в корзине с их количеством
в заказе + общая сумма заказа + магазин:

    [
        {
            "total_sum": 19990,
            "ordered_items": [
                {
                    "product_info": {
                        "product": "Смартфон Samsung A41",
                        "price": 19990
                    },
                    "quantity": 1
                }
            ],
            "shop": "Связной"
        }
    ]

**Изменить количество товара в корзине**

    PATCH   http://127.0.0.1:8000/basket/

В data необходимо передать список со словарями, включающими `id` 
заказываемого продукта со склада + новое количество:

    {
        "ordered_items": [
            {
                "product_info": 122,
                "quantity": 5
            },
            {
                "product_info": 123,
                "quantity": 5
            }
        ]
    }

При любых ошибках будет возвращена детализация:

    {
    "Status": false,
    "Изменено количество у товаров": 0,
    "Не удалось изменить количество у товаров": 2,
    "Errors": [
        "Товар с id 122 отсутствует в корзине",
        "Товар с id 123 отсутствует в корзине"
    ]
    }

При успехе:

    {
    "Status": true,
    "Изменено количество у товаров": 2
    }

**Удалить товар из корзины**

    DELETE  http://127.0.0.1:8000/basket/

В data необходимо передать список `ids` товаров к удалению:

    {
    "ids": [21, 2]
    }

При любых ошибках будет возвращаться детализация:

    {
    "Status": false,
    "Удалено товаров": 0,
    "Не удалось удалить товаров": 2,
    "Errors": [
        "В корзине нет товара с id 21",
        "В корзине нет товара с id 2"
    ]
    }

При успехе:

    {
    "Status": true,
    "Удалено товаров": 2
    }
__

### Управление заказами ПОКУПАТЕЛЕМ

Доступно только авторизованному пользователю.

**Просмотреть заказы пользователя + поиск и фильтрация**

    GET     http://127.0.0.1:8000/order/

Доступная параметризация запроса:

    'id' фильтр по номеру заказа
    'shop' поиск по магазину (без учета регистра, по частичному совпадению)
    'product' поиск по названию продукта (без учета регистра, по частичному совпадению)
    'state' фильтр по статусу заказов
    'date_before' фильтр по дате 20XX-XX-XX, раньше чем указанная
    'date_after' фильтр по дате 20XX-XX-XX, начиная с указанной

Возвращает список с основной информацией о заказах:

    [
        {
            "id": 10,
            "datetime": "2024-01-10T22:34:40.375241+03:00",
            "state": "new",
            "total_sum": 68000,
            "shop": "Связной"
        },
        {
            "id": 9,
            "datetime": "2024-01-10T01:03:53.861443+03:00",
            "state": "new",
            "total_sum": 21990,
            "shop": "Билайн"
        }
    ]

**Посмотреть детальную информацию по заказу**

    GET     http://127.0.0.1:8000/order/<id>/

Возвращает подробную информацию о конкретном заказе:

        {
            "id": 9,
            "state": "new",
            "datetime": "2024-01-10T01:03:53.861443+03:00",
            "total_sum": 21990,
            "ordered_items": [
                {
                    "product_info": {
                        "product": "Смартфон Apple iPhone 5s 16GB (titan grey)",
                        "price": 21990
                    },
                    "quantity": 1
                }
            ],
            "delivery_date": "2024-01-23",
            "delivery_time": "afternoon_15_18",
            "recipient_full_name": "Муртазин Игорь Ш",
            "contact": {
                "id": 1,
                "region": "Калининградская обл.",
                "district": "",
                "settlement": "Калининград гор.",
                "street": "Велосипедная ул.",
                "house": "10",
                "structure": "1",
                "building": "H",
                "apartment": "17"
            },
            "shop": "Билайн"
        }


**Разместить товар из корзины**

    POST    http://127.0.0.1:8000/order/

В data необходимо передать `id` АДРЕСА контакта, желаемую дату(не ранее следующего дня) и время доставки,
ФИО получателя

    {
    "contact": 6,
    "delivery_date": "2023-12-31",
    "delivery_time": "afternoon_15_18",
    "recipient_full_name": "Фамилия Имя Отчество"
    }

    Варианты выбора интервалов доставки:
    'morning_09_12',
    'afternoon_12_15',
    'afternoon_15_18',
    'evening_18_22',

При успехе:

    {
    "Status": true,
    "Статус заказа": "new"
    }

Статус заказа меняется на "new", на почту покупателю приходит письмо с
темой:

    Связной - Создан новый заказ №10 от 2024-01-10 22:34:40

В теле письма подробная информация о заказе:

    Вы создали новый заказ №10 в магазине Связной
    Состав заказа
    Смартфон Apple iPhone 5s 16GB (titan grey), Смартфоны, "Связной", цена: 21990 - 1 шт
    Смартфон Apple iPhone XR 256GB (красный), Смартфоны, "Связной", цена: 68000 - 1 шт
    Сумма заказа: 89990 ₽
    
    Адрес доставки
    Калининградская обл., Калининград гор. ул.: Велосипедная, дом: 10, корп.: 1 стр.:H кв.: 17
    Дата и время доставки: 23 января 2024 г. 15:00 - 18:00
    
    Получатель: Муртазина Алина Е, +7(965) 999-99-99
    
    Обращаем Ваше внимание, что дата и время доставки заказа могут быть изменены. В случае изменений Компания свяжется с Вами по указанному контактному номеру телефона

Менеджеру магазина также автоматически направляется письмо с темой:

        Создан новый заказ №10 от 2024-01-10 22:34:40

В теле письма подробная информация о заказе с внутренними артикулами и дополнительно информацией о доставке и клиенте:
 
       Состав заказа
        арт. 4200009, Смартфон Apple iPhone 5s 16GB (titan grey), Смартфоны, "Связной", цена: 21990 - 1 шт
        арт. 4216313, Смартфон Apple iPhone XR 256GB (красный), Смартфоны, "Связной", цена: 68000 - 1 шт
        Сумма заказа: 89990 ₽
        
        Адрес доставки
        Калининградская обл., Калининград гор. ул.: Велосипедная, дом: 10, корп.: 1 стр.:H кв.: 17
        Дата и время доставки: 23 января 2024 г. 15:00 - 18:00
        
        Получатель: Муртазина Алина Е, +7(965) 999-99-99
        
        Клиент: Алина Рыжая
__

### ПАРТНЕР - работа со статусом магазина

Доступно только авторизованному пользователю с ролью 'shop'. Действие
осуществляется с магазином, за которым закреплен пользователь-владелец
auth токена.

**Проверить текущий статус приема заказов магазином**

    GET     http://127.0.0.1:8000/partner/state/

В ответе придут данные магазина, за которым закреплен владелец токена

    {
    "id": 4,
    "name": "Связной",
    "url": "http://sv.ru",
    "state": true
    }

**Изменить статус приема заказов магазином**

    POST    http://127.0.0.1:8000/partner/state/

В data необходимо передать новый статус True или False:

    {
    "state": "True"
    }
__

### ПАРТНЕР - работа с заказами магазина

Доступно только авторизованному пользователю с ролью 'shop'. Действие
осуществляется с заказами магазина, за которым закреплен 
пользователь-владелец auth токена.

**Просмотреть заказы магазина + фильтрация и поиск**

    GET     http://127.0.0.1:8000/partner/orders/

Доступная параметризация запроса:

    'id' фильтр по номеру заказа
    'product' поиск по названию продукта (без учета регистра, частичное совпадение)
    'state' фильтр по статусу заказов
    'date' фильтр по дате 20XX-XX-XX, за определенный день
    'date_before' фильтр по дате 20XX-XX-XX, раньше чем указанная
    'date_after' фильтр по дате 20XX-XX-XX, начиная с указанной
    'sum_more' фильтр по сумме, заказы дороже value
    'sum_less' фильтр по сумме, заказы дешевле value
    'delivery_date_before' фильтр по дате доставки 20XX-XX-XX, раньше чем указанная
    'delivery_date_after' фильтр по дате доставки 20XX-XX-XX, начиная с указанной

Выводит список заказов с необходимой магазину информацией:

    [
        {
            "id": 12,
            "datetime": "2024-01-15T00:11:10.320126+03:00",
            "delivery_date": "2024-01-25",
            "delivery_time": "afternoon_15_18",
            "total_sum": 19990,
            "user": "Алина Рыжая",
            "recipient_full_name": "Муртазина Алина Е",
            "state": "new",
            "ordered_items": [
                {
                    "product_info": {
                        "id": 14,
                        "model": "sams41",
                        "external_id": 42099344,
                        "product": {
                            "name": "Смартфон Samsung A41",
                            "category": "Смартфоны"
                        },
                        "price": 19990,
                        "price_rrc": 19990
                    },
                    "quantity": 1
                }
            ],
            "contact": {
                "id": 1,
                "region": "Калининградская обл.",
                "district": "",
                "settlement": "Калининград гор.",
                "street": "Велосипедная ул.",
                "house": "10",
                "structure": "1",
                "building": "H",
                "apartment": "17"
            },
            "contact_phone": "9659999999",
            "shop": "Связной"
        }, ...]


**Изменить статус заказа**

    POST    http://127.0.0.1:8000/partner/orders/

В data необходимо передать `id` заказа и новый статус:

    {
        'id': 1
        'state': 'confirmed'
    }

Статус возможен только из вариантов, определенных в `models.py` в 
`ORDER_STATE_CHOICES`, за исключением ('basket', 'В корзине') - изменить
статус на 'В корзине' невозможно.

Если заказ существует и он на данный магазин, то статус будет изменен,
а покупателю придет на почту письмо об изменении статуса заказа:

    Тема: Связной - cтатус вашего заказа №10 от 2024-01-10 22:34:40 изменен на "Собран"

В теле письма детализация заказа:

    Ваш заказ №10 от 2024-01-10 22:34:40 Собран
    Состав заказа
    Смартфон Apple iPhone 5s 16GB (titan grey), Смартфоны, "Связной", цена: 21990 - 1 шт
    Смартфон Apple iPhone XR 256GB (красный), Смартфоны, "Связной", цена: 68000 - 1 шт
    Сумма заказа: 89990 ₽
    
    Адрес доставки
    Калининградская обл., Калининград гор. ул.: Велосипедная ул., дом: 10, корп.: 1 стр.: H кв.: 17
    Дата и время доставки: 12 января 2024 г. 18:00 - 22:00
    
    Получатель: Муртазина Алина Е, +7(965) 999-99-99
__

### ПАРТНЕР - управление остатками магазина, обновление прайса, прием поставок

Доступно только авторизованному пользователю с ролью 'shop'. Действие 
осуществляется с остатками магазина, за которым закреплен 
пользователь-владелец auth токена.

**Полностью обновить складские остатки магазина, создать новый магазин**

    POST        http://127.0.0.1:8000/partner/update/

В yaml-файле (аргумент `file`) передается полный список остатков магазина.
Все товары на остатках, не переданные в yaml, будут значиться с нулевым количеством.
Новые товары будут добавлены, уже имеющиеся на остатках - обновлены согласно информации в yaml-файле.

Для создания нового магазина в data необходимо передать `url` + прикрепить `yaml-файл` с остатками товара

    {
    "url": "http://bee.ru"
    }

При успехе:

    {
    "Status": true,
    "Загружено/обновлено товаров": 3
    }

При возникновении ошибок будет передаваться детализация:

    {
    "Status": true,
    "Загружено/обновлено товаров": 2,
    "Errors": [
        {
            "category_creation_failed": [
                8,
                "Flash-накопители",
                "ОШИБКА:  повторяющееся значение ключа нарушает ограничение уникальности \"backend_category_name_key\"\nDETAIL:  Ключ \"(name)=(Flash-накопители)\" уже существует.\n"
            ]
        }
    ],
    "Не удалось создать категорий": 1

**Принять новую поставку на склад, обновить цены, описание товаров**

Текущие остатки склада **суммируются** с указанными в yaml-накладной.

В yaml-файле (аргумент `file`) передается то, что поступает на склад, или переоценка/параметры товара.
При переоценке/изменении описания без фактического привоза товару в накладной необходимо установить
количество = 0.

    PATCH     http://127.0.0.1:8000/partner/update/

При успехе:

    {
    "Status": true,
    "Загружено/обновлено товаров": 3
    }

При ошибках будет возвращена детализация:
    
    {
    "Status": true,
    "Загружено/обновлено товаров": 2,
    "Errors": [
        {
            "category_creation_failed": [
                9,
                "Услуги",
                "ОШИБКА:  повторяющееся значение ключа нарушает ограничение уникальности \"backend_category_name_key\"\nDETAIL:  Ключ \"(name)=(Услуги)\" уже существует.\n"
            ]
        },
        {
            "product_info_creation_failed": [
                4216555,
                "Кабель для iPhone с магнитом"
            ]
        }
    ],
    "Не удалось создать категорий": 1,
    "Не удалось добавить товаров на остатки/обновить": 1
    }



___
#### Примечания 

+ Про запрет наличия в заказе товаров из разных магазинов - поскольку в проекте
предполагается управление заказами менеджером магазина, для меня логично, что магазин
не может модерировать заказ, включающий доставку из другой фирмы). Я изначально
по старому описанию поняла задачу так, что проект по сути площадка, соединяющая
разные магазины с покупателями, в таком случае, конечно, невозможно, чтобы магазин
видел и подтверждал чужие заказы. ~~Ну и, конечно, это дало возможность поиграть с валидацией 
админки, было увлекательно)~~
+ Импорт данных в селери сознательно реализован не на уровне самого файла, а на уровне
записи товара в базу, для того, чтобы была доступна для вывода информация об
ошибках при загрузке файла. Все ж таки для розницы не загрузить половину
накладной и при этом не выдать оповещения об этом показалось мне чересчур 
жестким троллингом от разработчика =)


___

#### Оставшиеся не решенными вопросы, по которым вменяемую информацию найти не получилось

+ Как реализовать связанные списки в админке? К примеру, при создании
заказа мы выбираем пользователя - как сделать, чтобы в окне ниже с 
выбором адреса выдавался список адресов именно указанного пользователя, 
а не вообще все адреса? 
+ Swagger + rest_framework_social_oauth2.urls: как параметризировать 
импортированный из внешней библиотеки url в swagger? При стандартном
указании схемы к view параметризация не подтягивается. Переопределить
внутри view проекта, как reset_password, не получилось, выдвает ошибки 
namespace, способы решения из интернета не помогли.
+ Как нормально конвертировать в dict данные из InMemoryUploadedFile
со структурой yaml'а? Я, конечно, написала кривой костыль, но, полагаю,
это все же делается не так и есть какая-нибудь нормальная библиотека,
задача-то типовая. 
Loader из примера проекта не сработал, выдает ошибку:

    ```raise ScannerError(None, None,yaml.scanner.ScannerError: mapping values are not allowed here```
+ Как в модели задать в default функцию с получением self-данных
объекта? Например, в заказе поле есть "Получатель доставки", мы хотим, чтобы
по умолчанию оно принимало значение имени создателя заказа, то есть, 
self.user c \_ \_str\_ \_-выводом информации? Но в прямом виде обращение
к self не работает, как это реализуется?
+ Как удалить из админки лишние таблицы OAuth2? 
Примеры из интернета
    ```
    from social_django.models import Association, Nonce, UserSocialAuth
    admin.site.unregister(Association)
    admin.site.unregister(Nonce)
    admin.site.unregister(UserSocialAuth)  
    ```
  никак не сработали, джанго не видит их как зарегистрированные.
    ```
    django.contrib.admin.sites.NotRegistered: The model Nonce is not registered
    ```